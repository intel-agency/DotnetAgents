@page "/chat"
@using DotnetAgents.Web.Services
@inject IAgentClientService AgentService
@rendermode InteractiveServer

<PageTitle>Agent Chat</PageTitle>

<h1>Agent Chat</h1>

<div class="chat-container">
    <div class="chat-messages" style="height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background-color: #f9f9f9;">
        @foreach (var message in chatMessages)
        {
            <div class="message @message.Type" style="margin-bottom: 10px; padding: 8px; border-radius: 5px; @(message.Type == "user" ? "background-color: #e3f2fd; text-align: right;" : "background-color: #f5f5f5;")">
                <strong>@(message.Type == "user" ? "You" : "Agent"):</strong>
                <div style="white-space: pre-wrap;">@message.Text</div>
            </div>
        }
        @if (isLoading)
        {
            <div class="message loading" style="margin-bottom: 10px; padding: 8px;">
                <em>Agent is thinking...</em>
            </div>
        }
    </div>

    <div class="chat-input">
        <div class="input-group">
            <input type="text" 
                   class="form-control" 
                   @bind="currentPrompt" 
                   @bind:event="oninput"
                   @onkeypress="HandleKeyPress"
                   placeholder="Type your message..." 
                   disabled="@isLoading" />
            <button class="btn btn-primary" @onclick="SendMessage" disabled="@(isLoading || string.IsNullOrWhiteSpace(currentPrompt))">
                Send
            </button>
        </div>
    </div>
</div>

@code {
    private string currentPrompt = string.Empty;
    private bool isLoading = false;
    private List<ChatMessage> chatMessages = new();

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(currentPrompt))
            return;

        var userMessage = currentPrompt.Trim();
        chatMessages.Add(new ChatMessage { Type = "user", Text = userMessage });
        currentPrompt = string.Empty;
        isLoading = true;

        try
        {
            var response = await AgentService.SendPromptAsync(userMessage);
            
            if (response != null && !string.IsNullOrEmpty(response.Response))
            {
                chatMessages.Add(new ChatMessage { Type = "agent", Text = response.Response });
            }
            else
            {
                chatMessages.Add(new ChatMessage { Type = "agent", Text = "No response received from agent." });
            }
        }
        catch (Exception ex)
        {
            chatMessages.Add(new ChatMessage { Type = "error", Text = $"Error: {ex.Message}" });
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isLoading && !string.IsNullOrWhiteSpace(currentPrompt))
        {
            await SendMessage();
        }
    }

    private class ChatMessage
    {
        public string Type { get; set; } = string.Empty;
        public string Text { get; set; } = string.Empty;
    }
}
